name: Update Fancy Clock

on:
  schedule:
    - cron: "*/5 * * * *"

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Generate Clock SVG
        run: |
          # Chicago local time
          H=$(TZ="America/Chicago" date +"%H")
          M=$(TZ="America/Chicago" date +"%M")
          S=$(TZ="America/Chicago" date +"%S")

          # Convert to clock angles
          H_ANGLE=$(( (H % 12) * 30 + M / 2 ))
          M_ANGLE=$(( M * 6 ))
          S_ANGLE=$(( S * 6 ))

          # Create SVG
          sed \
            -e "s/HOUR_ANGLE/$H_ANGLE/" \
            -e "s/MIN_ANGLE/$M_ANGLE/" \
            -e "s/SEC_ANGLE/$S_ANGLE/" \
            clock.svg.template > clock.svg

      - name: Fetch Bitcoin Price
        run: |
          # Fetch Bitcoin price from CoinGecko API
          BTC_DATA=$(curl -s "https://api.coingecko.com/api/v3/simple/price?ids=bitcoin&vs_currencies=usd&include_24hr_change=true")
          
          # Parse JSON using jq
          BTC_PRICE=$(echo $BTC_DATA | jq -r '.bitcoin.usd')
          BTC_CHANGE=$(echo $BTC_DATA | jq -r '.bitcoin.usd_24h_change')
          
          # Format price (remove decimals and add commas)
          BTC_PRICE_INT=${BTC_PRICE%.*}
          BTC_PRICE_FORMATTED=$(echo $BTC_PRICE_INT | sed ':a;s/\B[0-9]\{3\}\>/,&/;ta')
          
          # Format change to 2 decimals
          BTC_CHANGE_FORMATTED=$(printf "%.2f" $BTC_CHANGE)
          
          # Determine color and arrow
          if [ $(echo "$BTC_CHANGE >= 0" | awk '{print ($1 >= $3)}') -eq 1 ]; then
            COLOR="#10b981"
            ARROW="▲"
          else
            COLOR="#ef4444"
            ARROW="▼"
          fi
          
          # Create Bitcoin price SVG
          cat > bitcoin.svg << 'SVGEOF'
<svg width="300" height="80" xmlns="http://www.w3.org/2000/svg">
  <defs>
    <linearGradient id="bgGrad" x1="0%" y1="0%" x2="100%" y2="100%">
      <stop offset="0%" stop-color="#1a1a1a"/>
      <stop offset="100%" stop-color="#2d2d2d"/>
    </linearGradient>
  </defs>
  <rect width="300" height="80" rx="10" fill="url(#bgGrad)" stroke="#444" stroke-width="2"/>
  <text x="20" y="30" font-size="16" fill="#aaa" font-family="Arial, sans-serif">Bitcoin (BTC)</text>
  <text x="20" y="55" font-size="24" fill="#fff" font-weight="bold" font-family="Arial, sans-serif">$PRICE_PLACEHOLDER</text>
  <text x="20" y="72" font-size="14" fill="COLOR_PLACEHOLDER" font-family="Arial, sans-serif">ARROW_PLACEHOLDER CHANGE_PLACEHOLDER%</text>
</svg>
SVGEOF
          
          # Replace placeholders
          sed -i "s/PRICE_PLACEHOLDER/\$$BTC_PRICE_FORMATTED/" bitcoin.svg
          sed -i "s/COLOR_PLACEHOLDER/$COLOR/" bitcoin.svg
          sed -i "s/ARROW_PLACEHOLDER/$ARROW/" bitcoin.svg
          sed -i "s/CHANGE_PLACEHOLDER/$BTC_CHANGE_FORMATTED/" bitcoin.svg

      - name: Fetch S&P 500 Price
        run: |
          # Fetch S&P 500 data from Yahoo Finance API
          SP500_DATA=$(curl -s "https://query1.finance.yahoo.com/v8/finance/chart/%5EGSPC?interval=1d&range=1d")
          
          # Parse JSON using jq
          SP500_PRICE=$(echo $SP500_DATA | jq -r '.chart.result[0].meta.regularMarketPrice')
          SP500_PREV=$(echo $SP500_DATA | jq -r '.chart.result[0].meta.chartPreviousClose')
          
          # Calculate change
          SP500_CHANGE=$(echo "scale=2; (($SP500_PRICE - $SP500_PREV) / $SP500_PREV) * 100" | bc)
          
          # Format price with 2 decimals and commas
          SP500_PRICE_FORMATTED=$(printf "%.2f" $SP500_PRICE | sed ':a;s/\B[0-9]\{3\}\>/,&/;ta')
          SP500_CHANGE_FORMATTED=$(printf "%.2f" $SP500_CHANGE)
          
          # Determine color and arrow
          if [ $(echo "$SP500_CHANGE >= 0" | awk '{print ($1 >= $3)}') -eq 1 ]; then
            COLOR="#10b981"
            ARROW="▲"
          else
            COLOR="#ef4444"
            ARROW="▼"
          fi
          
          # Create S&P 500 SVG
          cat > sp500.svg << 'SVGEOF'
<svg width="300" height="80" xmlns="http://www.w3.org/2000/svg">
  <defs>
    <linearGradient id="bgGradSP" x1="0%" y1="0%" x2="100%" y2="100%">
      <stop offset="0%" stop-color="#1a1a1a"/>
      <stop offset="100%" stop-color="#2d2d2d"/>
    </linearGradient>
  </defs>
  <rect width="300" height="80" rx="10" fill="url(#bgGradSP)" stroke="#444" stroke-width="2"/>
  <text x="20" y="30" font-size="16" fill="#aaa" font-family="Arial, sans-serif">S&amp;P 500</text>
  <text x="20" y="55" font-size="24" fill="#fff" font-weight="bold" font-family="Arial, sans-serif">$PRICE_PLACEHOLDER</text>
  <text x="20" y="72" font-size="14" fill="COLOR_PLACEHOLDER" font-family="Arial, sans-serif">ARROW_PLACEHOLDER CHANGE_PLACEHOLDER%</text>
</svg>
SVGEOF
          
          # Replace placeholders
          sed -i "s/PRICE_PLACEHOLDER/$SP500_PRICE_FORMATTED/" sp500.svg
          sed -i "s/COLOR_PLACEHOLDER/$COLOR/" sp500.svg
          sed -i "s/ARROW_PLACEHOLDER/$ARROW/" sp500.svg
          sed -i "s/CHANGE_PLACEHOLDER/$SP500_CHANGE_FORMATTED/" sp500.svg

      - name: Commit
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add clock.svg bitcoin.svg sp500.svg
          git commit -m "Update clock, Bitcoin and S&P 500" || exit 0
          git pull --rebase
          git push
